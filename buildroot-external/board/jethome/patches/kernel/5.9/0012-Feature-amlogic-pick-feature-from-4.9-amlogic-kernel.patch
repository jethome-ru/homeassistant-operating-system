From f10a06fa5155a33171be2e2a618956178d2abe1c Mon Sep 17 00:00:00 2001
From: Vyacheslav Bocharov <devel@lexina.in>
Date: Sun, 28 Mar 2021 14:48:00 +0300
Subject: [PATCH 12/14] Feature: amlogic: pick feature from 4.9-amlogic kernel:
 inverse eth status led

---
 .../ethernet/stmicro/stmmac/dwmac-meson8b.c   | 53 +++++++++++++++++++
 1 file changed, 53 insertions(+)

diff --git a/drivers/net/ethernet/stmicro/stmmac/dwmac-meson8b.c b/drivers/net/ethernet/stmicro/stmmac/dwmac-meson8b.c
index 6d6bd77bb6af..be34b382d8a8 100644
--- a/drivers/net/ethernet/stmicro/stmmac/dwmac-meson8b.c
+++ b/drivers/net/ethernet/stmicro/stmmac/dwmac-meson8b.c
@@ -267,7 +267,17 @@ static int meson8b_devm_clk_prepare_enable(struct meson8b_dwmac *dwmac,
 
 	return 0;
 }
+static int meson8b_init_led_eth(struct meson8b_dwmac *dwmac, void __iomem *regCNTL, u32 leds)
+{
+	int ret;
+	void __iomem *backup;
+	backup = dwmac->regs;
+	dwmac->regs = regCNTL;
+	meson8b_dwmac_mask_bits(dwmac, 0, 0xff << 24, leds);
+	dwmac->regs = backup;
+	return 0;
 
+}
 static int meson8b_init_prg_eth(struct meson8b_dwmac *dwmac)
 {
 	u32 tx_dly_config, rx_dly_config, delay_config;
@@ -366,6 +376,9 @@ static int meson8b_dwmac_probe(struct platform_device *pdev)
 	struct plat_stmmacenet_data *plat_dat;
 	struct stmmac_resources stmmac_res;
 	struct meson8b_dwmac *dwmac;
+	void __iomem	*regCNTL;
+	u32	eth_leds;
+
 	int ret;
 
 	ret = stmmac_get_platform_resources(pdev, &stmmac_res);
@@ -437,6 +450,46 @@ static int meson8b_dwmac_probe(struct platform_device *pdev)
 	if (ret)
 		goto err_remove_config_dt;
 
+	/* backport from 4.9 amlogic kernel for led setup */
+	/* ETH_PHY_CNTL1 for internal phy amlogic devices
+	    bits 31:24
+	      bits 7:5 (31:29)
+	        000 - link_led & (~activity)
+	        001 - link_led
+	        010 - link_led & activity
+	        011 - link_led | activity
+	        100 - activity
+	        101 - rx_led
+	        110 - tx_led
+	        111 - duplex_led
+	      bits 4:2 (28:26)
+	        000 - speed100_led
+	        001 - activity & speed100_led
+	        010 - link_led & speed100_led
+	        011 - link_led & activity & speed100_led
+	        100 - speed10_led
+	        101 - activity & speed10_led
+	        110 - link_led & speed10_led
+	        111 - link_led & activity & speed10_led
+	      bit 1
+	        invert co_link_speed_led when output to gpio
+	      bit 0
+	        invert all led signal from phy
+	*/
+	if (!of_property_read_u32(pdev->dev.of_node, "amlogic,eth-leds",
+		 &eth_leds))
+	{
+		regCNTL  = devm_platform_ioremap_resource(pdev, 2);
+		if (!IS_ERR(regCNTL)) {
+			ret = meson8b_init_led_eth(dwmac, regCNTL, eth_leds << 24);
+			if (ret)
+				dev_info(&pdev->dev, "Something wrong with led setup\n");
+			else
+				dev_info(&pdev->dev, "LED setting supported\n");
+		}
+	}
+	/* end led setup */
+
 	plat_dat->bsp_priv = dwmac;
 
 	ret = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);
-- 
2.25.1

